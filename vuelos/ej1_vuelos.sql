-- Ejercicio 1
DROP TABLE RUTA CASCADE CONSTRAINT;
DROP TABLE VUELO CASCADE CONSTRAINT;
DROP TABLE AVION CASCADE CONSTRAINT;

--1

CREATE TABLE RUTA (
    COD NUMBER(3),
    COMPAN VARCHAR2(3) NOT NULL,
    ORIGEN VARCHAR2(10) NOT NULL,
    DESTINO VARCHAR2(10) NOT NULL,
    NUM_HORAS NUMBER(2) NOT NULL,

    CONSTRAINT pk_ruta PRIMARY KEY (COD),
    CONSTRAINT chk_compan CHECK (COMPAN IN ('IBE', 'SPA', 'AIR'))
    
);

CREATE TABLE AVION (
    MAT VARCHAR2(3),
    MODELO VARCHAR2(10) NOT NULL,
    PLAZAS NUMBER(3) NOT NULL,
    FECHA_REV DATE,

    CONSTRAINT pk_avion PRIMARY KEY (MAT),
    CONSTRAINT chk_plazas CHECK (PLAZAS BETWEEN 5 AND 300)  
);

CREATE TABLE VUELO (
    COD NUMBER(3),
    MAT VARCHAR2(3),
    OCUPACION NUMBER(3),

    CONSTRAINT fk_vuelo_avion FOREIGN KEY (MAT) REFERENCES AVION(MAT),
    CONSTRAINT chk_ocupacion CHECK (OCUPACION <= 300)

);


-- 2.1
ALTER TABLE VUELO ADD FECHA DATE;

-- 2.2
ALTER TABLE VUELO MODIFY (FECHA NOT NULL);

-- 2.3 
ALTER TABLE VUELO ADD CONSTRAINT
fk_vuelo_ruta FOREIGN KEY (COD)
REFERENCES RUTA (COD);


-- 2.4 
ALTER TABLE VUELO ADD CONSTRAINT
pk_vuelo PRIMARY KEY (COD, MAT, FECHA);


-- 3
INSERT INTO RUTA (COD, COMPAN, ORIGEN, DESTINO, NUM_HORAS) VALUES (111, 'IBE', 'MADRID', 'LONDRES', 3);
INSERT INTO RUTA (COD, COMPAN, ORIGEN, DESTINO, NUM_HORAS) VALUES (222, 'IBE', 'MADRID', 'PARIS', 1);
INSERT INTO RUTA (COD, COMPAN, ORIGEN, DESTINO, NUM_HORAS) VALUES (333, 'SPA', 'MADRID', 'BARCELONA', 1);
INSERT INTO RUTA (COD, COMPAN, ORIGEN, DESTINO, NUM_HORAS) VALUES (444, 'AIR', 'MADRID', 'BARCELONA', 1);

INSERT INTO AVION (MAT, MODELO, PLAZAS, FECHA_REV) VALUES ('AAA', 'ABUS-200', 200, TO_DATE('10-JUN-2018', 'DD-MON-YYYY'));
INSERT INTO AVION (MAT, MODELO, PLAZAS, FECHA_REV) VALUES ('BBB', 'ABUS-280', 280, NULL);
INSERT INTO AVION (MAT, MODELO, PLAZAS, FECHA_REV) VALUES ('CCC', 'B-747', 300, NULL);
INSERT INTO AVION (MAT, MODELO, PLAZAS, FECHA_REV) VALUES ('DDD', 'B-777', 250, TO_DATE('10-OCT-2019', 'DD-MON-YYYY'));

INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (111, 'BBB', 250, TO_DATE('10-FEB-2018', 'DD-MON-YYYY'));
INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (222, 'CCC', 200, TO_DATE('10-FEB-2018', 'DD-MON-YYYY'));
INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (333, 'AAA', 200, TO_DATE('10-FEB-2018', 'DD-MON-YYYY'));
INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (444, 'DDD', 250, TO_DATE('10-FEB-2018', 'DD-MON-YYYY'));
INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (333, 'AAA', 100, TO_DATE('10-MAY-2018', 'DD-MON-YYYY'));
INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (444, 'DDD', 150, TO_DATE('10-MAY-2018', 'DD-MON-YYYY'));
INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (333, 'AAA', 50, TO_DATE('10-JUN-2018', 'DD-MON-YYYY'));
INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (444, 'DDD', 75, TO_DATE('10-JUN-2018', 'DD-MON-YYYY'));



-- 4.1
UPDATE VUELO SET FECHA = FECHA + 1
WHERE FECHA = TO_DATE('10-MAY-2018');

-- 4.2
UPDATE RUTA SET NUM_HORAS = NUM_HORAS + 1
WHERE DESTINO = 'PARIS';

-- 4.3
-- el primero no funciona porque no existe ningun avion con esa matricula
-- se viola la clave foranea
INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (111, 'EEE', 220, '10-MAY-2019');

INSERT INTO VUELO (COD, MAT, OCUPACION, FECHA) VALUES (111, 'BBB', 220, '10-MAY-2019');


COMMIT;